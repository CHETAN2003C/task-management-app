@page "/tasks/create"
@using TaskManagementApp.Models
@using TaskManagementApp.Services
@inject TaskService TaskService
@inject CategoryService CategoryService
@inject NavigationManager Navigation

<PageTitle>Create Task</PageTitle>

<div class="form-container">
    <div class="form-header">
        <h1>➕ Create New Task</h1>
        <button class="btn-back" @onclick="NavigateBack">← Back</button>
    </div>

    <EditForm Model="@newTask" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary class="validation-summary" />

        <div class="form-group">
            <label for="title">Task Title *</label>
            <InputText id="title" class="form-control" @bind-Value="newTask.Title" placeholder="Enter task title" />
            <ValidationMessage For="@(() => newTask.Title)" />
        </div>

        <div class="form-group">
            <label for="description">Description</label>
            <InputTextArea id="description" class="form-control" @bind-Value="newTask.Description" 
                          placeholder="Enter task description (optional)" rows="4" />
            <ValidationMessage For="@(() => newTask.Description)" />
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="dueDate">Due Date *</label>
                <InputDate id="dueDate" class="form-control" @bind-Value="newTask.DueDate" />
                <ValidationMessage For="@(() => newTask.DueDate)" />
            </div>

            <div class="form-group">
                <label for="priority">Priority *</label>
                <InputSelect id="priority" class="form-control" @bind-Value="newTask.Priority">
                    <option value="@Priority.Low">Low</option>
                    <option value="@Priority.Medium">Medium</option>
                    <option value="@Priority.High">High</option>
                </InputSelect>
                <ValidationMessage For="@(() => newTask.Priority)" />
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="startTime">Start Time</label>
                <InputText type="time" id="startTime" class="form-control" @bind-Value="startTimeString" />
            </div>

            <div class="form-group">
                <label for="endTime">End Time</label>
                <InputText type="time" id="endTime" class="form-control" @bind-Value="endTimeString" />
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="estimatedDuration">Estimated Duration (minutes)</label>
                <InputNumber id="estimatedDuration" class="form-control" @bind-Value="newTask.EstimatedDurationMinutes" 
                            placeholder="e.g., 60" min="0" />
                <ValidationMessage For="@(() => newTask.EstimatedDurationMinutes)" />
            </div>

            <div class="form-group">
                <label for="actualDuration">Actual Duration (minutes)</label>
                <InputNumber id="actualDuration" class="form-control" @bind-Value="newTask.ActualDurationMinutes" 
                            placeholder="e.g., 45" min="0" />
                <ValidationMessage For="@(() => newTask.ActualDurationMinutes)" />
            </div>
        </div>

        <div class="form-group">
            <label for="category">Category</label>
            <InputSelect id="category" class="form-control" @bind-Value="newTask.CategoryId">
                <option value="">-- Select Category (Optional) --</option>
                @foreach (var category in categories)
                {
                    <option value="@category.Id">@category.Name</option>
                }
            </InputSelect>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Create Task</button>
            <button type="button" class="btn btn-secondary" @onclick="NavigateBack">Cancel</button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public int? CategoryId { get; set; }

    private List<Category> categories = new();
    private TaskItem newTask = new()
    {
        DueDate = DateTime.Now.AddDays(1),
        Priority = Priority.Medium
    };
    
    private string? startTimeString;
    private string? endTimeString;

    protected override async Task OnInitializedAsync()
    {
        categories = await CategoryService.GetAllCategoriesAsync();
        
        if (CategoryId.HasValue)
        {
            newTask.CategoryId = CategoryId.Value;
        }
    }

    private async Task HandleSubmit()
    {
        // Convert time strings to TimeSpan
        if (!string.IsNullOrEmpty(startTimeString) && TimeSpan.TryParse(startTimeString, out var startTime))
        {
            newTask.StartTime = startTime;
        }
        
        if (!string.IsNullOrEmpty(endTimeString) && TimeSpan.TryParse(endTimeString, out var endTime))
        {
            newTask.EndTime = endTime;
        }
        
        await TaskService.CreateTaskAsync(newTask);
        Navigation.NavigateTo("/tasks");
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/tasks");
    }
}
