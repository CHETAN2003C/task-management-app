@page "/tasks"
@using TaskManagementApp.Models
@using TaskManagementApp.Services
@inject TaskService TaskService
@inject NavigationManager Navigation

<PageTitle>Task List</PageTitle>

<div class="task-list-container">
    <div class="header-section">
        <h1>ğŸ“‹ My Tasks</h1>
        <button class="btn btn-primary" @onclick="NavigateToCreate">
            â• Create New Task
        </button>
    </div>

    <div class="filter-section">
        <button class="filter-btn @(filterStatus == "all" ? "active" : "")" @onclick='() => FilterTasks("all")'>
            All (@allTasks.Count)
        </button>
        <button class="filter-btn @(filterStatus == "pending" ? "active" : "")" @onclick='() => FilterTasks("pending")'>
            Pending (@allTasks.Count(t => !t.IsCompleted))
        </button>
        <button class="filter-btn @(filterStatus == "completed" ? "active" : "")" @onclick='() => FilterTasks("completed")'>
            Completed (@allTasks.Count(t => t.IsCompleted))
        </button>
    </div>

    @if (filteredTasks.Any())
    {
        <div class="tasks-grid">
            @foreach (var task in filteredTasks)
            {
                <div class="task-card @(task.IsCompleted ? "completed" : "") priority-@task.Priority.ToString().ToLower()">
                    <div class="task-header">
                        <div class="task-checkbox">
                            <input type="checkbox" checked="@task.IsCompleted" @onchange="() => ToggleCompletion(task.Id)" />
                        </div>
                        <div class="task-title">
                            <h3 class="@(task.IsCompleted ? "strikethrough" : "")">@task.Title</h3>
                            <span class="priority-badge priority-@task.Priority.ToString().ToLower()">
                                @task.Priority
                            </span>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(task.Description))
                    {
                        <p class="task-description">@task.Description</p>
                    }

                    <div class="task-footer">
                        <div class="task-date">
                            <span class="@(task.DueDate < DateTime.Now && !task.IsCompleted ? "overdue" : "")">
                                ğŸ“… Due: @task.DueDate.ToString("MMM dd, yyyy")
                            </span>
                        </div>
                        <div class="task-actions">
                            <button class="btn-icon" @onclick="() => NavigateToEdit(task.Id)" title="Edit">
                                âœï¸
                            </button>
                            <button class="btn-icon delete" @onclick="() => DeleteTask(task.Id)" title="Delete">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <h3>No tasks found</h3>
            <p>@(filterStatus == "all" ? "Create your first task to get started!" : $"No {filterStatus} tasks.")</p>
            @if (filterStatus == "all")
            {
                <button class="btn btn-primary" @onclick="NavigateToCreate">
                    â• Create Task
                </button>
            }
        </div>
    }
</div>

@code {
    private List<TaskItem> allTasks = new();
    private List<TaskItem> filteredTasks = new();
    private string filterStatus = "all";

    protected override async Task OnInitializedAsync()
    {
        await LoadTasks();
    }

    private async Task LoadTasks()
    {
        allTasks = await TaskService.GetAllTasksAsync();
        FilterTasks(filterStatus);
    }

    private void FilterTasks(string status)
    {
        filterStatus = status;
        filteredTasks = status switch
        {
            "pending" => allTasks.Where(t => !t.IsCompleted).ToList(),
            "completed" => allTasks.Where(t => t.IsCompleted).ToList(),
            _ => allTasks
        };
    }

    private async Task ToggleCompletion(int taskId)
    {
        await TaskService.ToggleTaskCompletionAsync(taskId);
        await LoadTasks();
    }

    private async Task DeleteTask(int taskId)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this task?"))
        {
            await TaskService.DeleteTaskAsync(taskId);
            await LoadTasks();
        }
    }

    private void NavigateToCreate()
    {
        Navigation.NavigateTo("/tasks/create");
    }

    private void NavigateToEdit(int taskId)
    {
        Navigation.NavigateTo($"/tasks/edit/{taskId}");
    }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;
}
