@page "/"
@using TaskManagementApp.Services
@using TaskManagementApp.Models
@using Microsoft.JSInterop
@inject TaskService TaskService
@inject CategoryService CategoryService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Task Management - Home</PageTitle>

<div class="home-container">
    <div class="hero-section">
        <h1 class="display-4">üìã Task Management System</h1>
        <p class="lead">Organize your work efficiently and boost productivity</p>
        <button class="btn btn-primary btn-lg" @onclick="NavigateToTasks">
            View All Tasks
        </button>
    </div>

    <div class="stats-section">
        <h2>Quick Overview</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-value">@totalTasks</div>
                <div class="stat-label">Total Tasks</div>
            </div>
            <div class="stat-card pending">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-value">@pendingTasks</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card completed">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-value">@completedTasks</div>
                <div class="stat-label">Completed</div>
            </div>
            <div class="stat-card high-priority">
                <div class="stat-icon">üî•</div>
                <div class="stat-value">@highPriorityTasks</div>
                <div class="stat-label">High Priority</div>
            </div>
        </div>
    </div>

    <div class="charts-section">
        <h2>Task Analytics</h2>
        <div class="charts-grid">
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <div class="features-section">
        <h2>Features</h2>
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">‚ûï</div>
                <h3>Create Tasks</h3>
                <p>Add new tasks with titles, descriptions, due dates, and priorities</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">‚úèÔ∏è</div>
                <h3>Edit Tasks</h3>
                <p>Update task details anytime to keep your workflow current</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">üéØ</div>
                <h3>Set Priorities</h3>
                <p>Organize tasks by Low, Medium, or High priority levels</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">‚úîÔ∏è</div>
                <h3>Track Progress</h3>
                <p>Mark tasks as complete and monitor your productivity</p>
            </div>
        </div>
    </div>
</div>

@code {
    private int totalTasks = 0;
    private int pendingTasks = 0;
    private int completedTasks = 0;
    private int highPriorityTasks = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadStatistics();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeCharts();
        }
    }

    private async Task LoadStatistics()
    {
        var allTasks = await TaskService.GetAllTasksAsync();
        totalTasks = allTasks.Count;
        pendingTasks = allTasks.Count(t => !t.IsCompleted);
        completedTasks = allTasks.Count(t => t.IsCompleted);
        highPriorityTasks = allTasks.Count(t => t.Priority == TaskManagementApp.Models.Priority.High && !t.IsCompleted);
    }

    private async Task InitializeCharts()
    {
        try
        {
            await InitializeCategoryChart();
            await InitializeTrendChart();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing charts: {ex.Message}");
        }
    }

    private async Task InitializeCategoryChart()
    {
        var categories = await CategoryService.GetAllCategoriesAsync();
        var allTasks = await TaskService.GetAllTasksAsync();

        if (categories.Any())
        {
            var categoryNames = categories.Select(c => c.Name).ToArray();
            var taskCounts = categories.Select(c => allTasks.Count(t => t.CategoryId == c.Id)).ToArray();

            // Add "Uncategorized" if there are tasks without a category
            var uncategorizedCount = allTasks.Count(t => t.CategoryId == null);
            if (uncategorizedCount > 0)
            {
                categoryNames = categoryNames.Append("Uncategorized").ToArray();
                taskCounts = taskCounts.Append(uncategorizedCount).ToArray();
            }

            if (categoryNames.Any() && taskCounts.Any())
            {
                await JSRuntime.InvokeVoidAsync("initCategoryChart", categoryNames, taskCounts);
            }
        }
    }

    private async Task InitializeTrendChart()
    {
        var allTasks = await TaskService.GetAllTasksAsync();
        var today = DateTime.Now.Date;
        var dates = new List<string>();
        var completedCounts = new List<int>();
        var createdCounts = new List<int>();

        // Get data for last 30 days
        for (int i = 29; i >= 0; i--)
        {
            var date = today.AddDays(-i);
            dates.Add(date.ToString("MM/dd"));
            
            // Count tasks completed on this date
            var completed = allTasks.Count(t => t.IsCompleted && t.DueDate.Date == date);
            completedCounts.Add(completed);
            
            // Count tasks created on this date
            var created = allTasks.Count(t => t.CreatedAt.Date == date);
            createdCounts.Add(created);
        }

        await JSRuntime.InvokeVoidAsync("initTrendChart", dates.ToArray(), completedCounts.ToArray(), createdCounts.ToArray());
    }

    private void NavigateToTasks()
    {
        Navigation.NavigateTo("/tasks");
    }

    public async ValueTask DisposeAsync()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("destroyCharts");
        }
        catch
        {
            // Ignore errors during disposal
        }
    }
}
