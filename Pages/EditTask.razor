@page "/tasks/edit/{TaskId:int}"
@using TaskManagementApp.Models
@using TaskManagementApp.Services
@inject TaskService TaskService
@inject CategoryService CategoryService
@inject NavigationManager Navigation

<PageTitle>Edit Task</PageTitle>

<div class="form-container">
    @if (task != null)
    {
        <div class="form-header">
            <h1>✏️ Edit Task</h1>
            <button class="btn-back" @onclick="NavigateBack">← Back</button>
        </div>

        <EditForm Model="@task" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary class="validation-summary" />

            <div class="form-group">
                <label for="title">Task Title *</label>
                <InputText id="title" class="form-control" @bind-Value="task.Title" placeholder="Enter task title" />
                <ValidationMessage For="@(() => task.Title)" />
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <InputTextArea id="description" class="form-control" @bind-Value="task.Description" 
                              placeholder="Enter task description (optional)" rows="4" />
                <ValidationMessage For="@(() => task.Description)" />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="dueDate">Due Date *</label>
                    <InputDate id="dueDate" class="form-control" @bind-Value="task.DueDate" />
                    <ValidationMessage For="@(() => task.DueDate)" />
                </div>

                <div class="form-group">
                    <label for="priority">Priority *</label>
                    <InputSelect id="priority" class="form-control" @bind-Value="task.Priority">
                        <option value="@Priority.Low">Low</option>
                        <option value="@Priority.Medium">Medium</option>
                        <option value="@Priority.High">High</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => task.Priority)" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="startTime">Start Time</label>
                    <InputText type="time" id="startTime" class="form-control" @bind-Value="startTimeString" />
                </div>

                <div class="form-group">
                    <label for="endTime">End Time</label>
                    <InputText type="time" id="endTime" class="form-control" @bind-Value="endTimeString" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="estimatedDuration">Estimated Duration (minutes)</label>
                    <InputNumber id="estimatedDuration" class="form-control" @bind-Value="task.EstimatedDurationMinutes" 
                                placeholder="e.g., 60" min="0" />
                    <ValidationMessage For="@(() => task.EstimatedDurationMinutes)" />
                </div>

                <div class="form-group">
                    <label for="actualDuration">Actual Duration (minutes)</label>
                    <InputNumber id="actualDuration" class="form-control" @bind-Value="task.ActualDurationMinutes" 
                                placeholder="e.g., 45" min="0" />
                    <ValidationMessage For="@(() => task.ActualDurationMinutes)" />
                </div>
            </div>

            <div class="form-group">
                <label for="category">Category</label>
                <InputSelect id="category" class="form-control" @bind-Value="task.CategoryId">
                    <option value="">-- No Category --</option>
                    @foreach (var category in categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                </InputSelect>
            </div>

            <div class="form-group">
                <label class="checkbox-label">
                    <InputCheckbox @bind-Value="task.IsCompleted" />
                    <span>Mark as completed</span>
                </label>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Update Task</button>
                <button type="button" class="btn btn-secondary" @onclick="NavigateBack">Cancel</button>
            </div>
        </EditForm>
    }
    else
    {
        <div class="loading">Loading task...</div>
    }
</div>

@code {
    [Parameter]
    public int TaskId { get; set; }

    private TaskItem? task;
    private List<Category> categories = new();
    private string? startTimeString;
    private string? endTimeString;

    protected override async Task OnInitializedAsync()
    {
        categories = await CategoryService.GetAllCategoriesAsync();
        task = await TaskService.GetTaskByIdAsync(TaskId);
        if (task == null)
        {
            Navigation.NavigateTo("/tasks");
        }
        else
        {
            // Convert TimeSpan to string for time inputs
            startTimeString = task.StartTime?.ToString(@"hh\:mm");
            endTimeString = task.EndTime?.ToString(@"hh\:mm");
        }
    }

    private async Task HandleSubmit()
    {
        if (task != null)
        {
            // Convert time strings to TimeSpan
            if (!string.IsNullOrEmpty(startTimeString) && TimeSpan.TryParse(startTimeString, out var startTime))
            {
                task.StartTime = startTime;
            }
            else
            {
                task.StartTime = null;
            }
            
            if (!string.IsNullOrEmpty(endTimeString) && TimeSpan.TryParse(endTimeString, out var endTime))
            {
                task.EndTime = endTime;
            }
            else
            {
                task.EndTime = null;
            }
            
            await TaskService.UpdateTaskAsync(task);
            Navigation.NavigateTo("/tasks");
        }
    }

    private void NavigateBack()
    {
        Navigation.NavigateTo("/tasks");
    }
}
